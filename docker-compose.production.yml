version: '3.8'

services:
  # NGINX Load Balancer
  nginx:
    image: nginx:alpine
    container_name: colabrix-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app-1
      - app-2
      - app-3
    networks:
      - colabrix-network
    restart: unless-stopped

  # PostgreSQL Master
  postgres-master:
    image: postgres:15-alpine
    container_name: colabrix-postgres-master
    environment:
      POSTGRES_DB: colabrix_prod
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./config/postgres/master:/docker-entrypoint-initdb.d
    networks:
      - colabrix-network
    command: >
      postgres -c wal_level=replica
      -c max_wal_senders=5
      -c max_replication_slots=5
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/data/archive/%f && cp %p /var/lib/postgresql/data/archive/%f'
      -c shared_preload_libraries='pg_stat_statements'
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # PostgreSQL Replica 1
  postgres-replica-1:
    image: postgres:15-alpine
    container_name: colabrix-postgres-replica-1
    environment:
      POSTGRES_DB: colabrix_prod
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGUSER: postgres
      POSTGRES_MASTER_SERVICE: postgres-master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
    ports:
      - "5433:5432"
    volumes:
      - postgres_replica_1_data:/var/lib/postgresql/data
    networks:
      - colabrix-network
    depends_on:
      postgres-master:
        condition: service_healthy
    restart: unless-stopped

  # PostgreSQL Replica 2
  postgres-replica-2:
    image: postgres:15-alpine
    container_name: colabrix-postgres-replica-2
    environment:
      POSTGRES_DB: colabrix_prod
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGUSER: postgres
      POSTGRES_MASTER_SERVICE: postgres-master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
    ports:
      - "5434:5432"
    volumes:
      - postgres_replica_2_data:/var/lib/postgresql/data
    networks:
      - colabrix-network
    depends_on:
      postgres-master:
        condition: service_healthy
    restart: unless-stopped

  # Redis Cluster Nodes
  redis-node-1:
    image: redis:7-alpine
    container_name: colabrix-redis-1
    ports:
      - "7000:7000"
      - "17000:17000"
    volumes:
      - redis_1_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7000 --cluster-enabled yes --cluster-config-file nodes-7000.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  redis-node-2:
    image: redis:7-alpine
    container_name: colabrix-redis-2
    ports:
      - "7001:7001"
      - "17001:17001"
    volumes:
      - redis_2_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7001 --cluster-enabled yes --cluster-config-file nodes-7001.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  redis-node-3:
    image: redis:7-alpine
    container_name: colabrix-redis-3
    ports:
      - "7002:7002"
      - "17002:17002"
    volumes:
      - redis_3_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7002 --cluster-enabled yes --cluster-config-file nodes-7002.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  redis-node-4:
    image: redis:7-alpine
    container_name: colabrix-redis-4
    ports:
      - "7003:7003"
      - "17003:17003"
    volumes:
      - redis_4_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7003 --cluster-enabled yes --cluster-config-file nodes-7003.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  redis-node-5:
    image: redis:7-alpine
    container_name: colabrix-redis-5
    ports:
      - "7004:7004"
      - "17004:17004"
    volumes:
      - redis_5_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7004 --cluster-enabled yes --cluster-config-file nodes-7004.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  redis-node-6:
    image: redis:7-alpine
    container_name: colabrix-redis-6
    ports:
      - "7005:7005"
      - "17005:17005"
    volumes:
      - redis_6_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7005 --cluster-enabled yes --cluster-config-file nodes-7005.conf --cluster-node-timeout 5000 --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped

  # MongoDB Replica Set
  mongodb-primary:
    image: mongo:7
    container_name: colabrix-mongodb-primary
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
      MONGO_INITDB_DATABASE: colabrix_chat
    ports:
      - "27017:27017"
    volumes:
      - mongodb_primary_data:/data/db
    networks:
      - colabrix-network
    command: mongod --replSet rs0 --oplogSize 128
    restart: unless-stopped

  mongodb-secondary:
    image: mongo:7
    container_name: colabrix-mongodb-secondary
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
      MONGO_INITDB_DATABASE: colabrix_chat
    ports:
      - "27018:27017"
    volumes:
      - mongodb_secondary_data:/data/db
    networks:
      - colabrix-network
    command: mongod --replSet rs0 --oplogSize 128
    restart: unless-stopped



  # Application Instances
  app-1:
    build: .
    container_name: colabrix-app-1
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-master:5432/colabrix_prod
      - DATABASE_READ_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-replica-1:5432/colabrix_prod
      - MONGODB_URL=mongodb://admin:${MONGODB_PASSWORD}@mongodb-primary:27017/colabrix_chat?authSource=admin
      - REDIS_CLUSTER_URLS=redis://redis-node-1:7000,redis://redis-node-2:7001,redis://redis-node-3:7002,redis://redis-node-4:7003,redis://redis-node-5:7004,redis://redis-node-6:7005
    networks:
      - colabrix-network
    restart: unless-stopped

  app-2:
    build: .
    container_name: colabrix-app-2
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-master:5432/colabrix_prod
      - DATABASE_READ_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-replica-2:5432/colabrix_prod
      - MONGODB_URL=mongodb://admin:${MONGODB_PASSWORD}@mongodb-primary:27017/colabrix_chat?authSource=admin
      - REDIS_CLUSTER_URLS=redis://redis-node-1:7000,redis://redis-node-2:7001,redis://redis-node-3:7002,redis://redis-node-4:7003,redis://redis-node-5:7004,redis://redis-node-6:7005
    networks:
      - colabrix-network
    restart: unless-stopped

  app-3:
    build: .
    container_name: colabrix-app-3
    depends_on:
      postgres-master:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-master:5432/colabrix_prod
      - DATABASE_READ_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres-replica-1:5432/colabrix_prod
      - MONGODB_URL=mongodb://admin:${MONGODB_PASSWORD}@mongodb-primary:27017/colabrix_chat?authSource=admin
      - REDIS_CLUSTER_URLS=redis://redis-node-1:7000,redis://redis-node-2:7001,redis://redis-node-3:7002,redis://redis-node-4:7003,redis://redis-node-5:7004,redis://redis-node-6:7005
    networks:
      - colabrix-network
    restart: unless-stopped


volumes:
  postgres_master_data:
  postgres_replica_1_data:
  postgres_replica_2_data:
  redis_1_data:
  redis_2_data:
  redis_3_data:
  redis_4_data:
  redis_5_data:
  redis_6_data:
  mongodb_primary_data:
  mongodb_secondary_data:

networks:
  colabrix-network:
    driver: bridge