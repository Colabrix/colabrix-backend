version: '3.8'

services:
  # PostgreSQL Master
  postgres-master:
    image: postgres:15-alpine
    container_name: colabrix-postgres-master
    environment:
      POSTGRES_DB: colabrix_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicator_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
      - ./config/postgres/master:/docker-entrypoint-initdb.d
    networks:
      - colabrix-network
    command: >
      postgres -c wal_level=replica
      -c max_wal_senders=3
      -c max_replication_slots=3
      -c hot_standby=on
      -c archive_mode=on
      -c archive_command='test ! -f /var/lib/postgresql/data/archive/%f && cp %p /var/lib/postgresql/data/archive/%f'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Replica
  postgres-replica:
    image: postgres:15-alpine
    container_name: colabrix-postgres-replica
    environment:
      POSTGRES_DB: colabrix_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      PGUSER: postgres
      POSTGRES_MASTER_SERVICE: postgres-master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicator_password
    ports:
      - "5433:5432"
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    networks:
      - colabrix-network
    depends_on:
      postgres-master:
        condition: service_healthy
    command: >
      bash -c "
      if [ ! -s /var/lib/postgresql/data/PG_VERSION ]; then
        pg_basebackup -h postgres-master -D /var/lib/postgresql/data -U replicator -v -P -W
        echo 'standby_mode = on' >> /var/lib/postgresql/data/recovery.conf
        echo 'primary_conninfo = host=postgres-master port=5432 user=replicator password=replicator_password' >> /var/lib/postgresql/data/recovery.conf
        echo 'trigger_file = /var/lib/postgresql/data/trigger_file' >> /var/lib/postgresql/data/recovery.conf
      fi
      postgres -c hot_standby=on
      "

  # Redis Cluster
  redis-node-1:
    image: redis:7-alpine
    container_name: colabrix-redis-1
    ports:
      - "7000:7000"
      - "17000:17000"
    volumes:
      - redis_1_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7000 --cluster-enabled yes --cluster-config-file nodes-7000.conf --cluster-node-timeout 5000 --appendonly yes

  redis-node-2:
    image: redis:7-alpine
    container_name: colabrix-redis-2
    ports:
      - "7001:7001"
      - "17001:17001"
    volumes:
      - redis_2_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7001 --cluster-enabled yes --cluster-config-file nodes-7001.conf --cluster-node-timeout 5000 --appendonly yes

  redis-node-3:
    image: redis:7-alpine
    container_name: colabrix-redis-3
    ports:
      - "7002:7002"
      - "17002:17002"
    volumes:
      - redis_3_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - colabrix-network
    command: redis-server /usr/local/etc/redis/redis.conf --port 7002 --cluster-enabled yes --cluster-config-file nodes-7002.conf --cluster-node-timeout 5000 --appendonly yes

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: colabrix-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: mongopass
      MONGO_INITDB_DATABASE: colabrix_chat
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - colabrix-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh mongodb://admin:mongopass@localhost:27017/backend_chat --quiet
      interval: 10s
      timeout: 10s
      retries: 5





  # Application
  app:
    build: .
    container_name: colabrix-app
    ports:
      - "3000:3000"
    depends_on:
      postgres-master:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://postgres:password@postgres-master:5432/colabrix_dev
      - DATABASE_READ_URL=postgresql://postgres:password@postgres-replica:5432/colabrix_dev
      - MONGODB_URL=mongodb://admin:mongopass@mongodb:27017/colabrix_chat?authSource=admin
      - REDIS_CLUSTER_URLS=redis://redis-node-1:7000,redis://redis-node-2:7001,redis://redis-node-3:7002
    volumes:
      - ./src:/app/src
      - ./prisma:/app/prisma
    networks:
      - colabrix-network
    restart: unless-stopped

volumes:
  postgres_master_data:
  postgres_replica_data:
  redis_1_data:
  redis_2_data:
  redis_3_data:
  mongodb_data:

networks:
  colabrix-network:
    driver: bridge